<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GDataManage</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-[#0f5b70] text-white p-6">
    <div class="text-2xl font-bold mb-8">기획데이터 관리</div>

    <nav class="space-y-3">
      <button id="nav-register" class="w-full text-left px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20">
        기획 데이터 등록
      </button>
      <button id="nav-view" class="w-full text-left px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20">
        기획 데이터 확인
      </button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-8">
    <!-- Top -->
    <header class="mb-6">
      <h1 id="pageTitle" class="text-2xl font-bold text-gray-900">기획 데이터 등록</h1>
      <p class="text-gray-600 mt-1">업데이트 작업별 변경 데이터(P4 경로/테이블 등)를 기록합니다.</p>
    </header>

    <!-- Alerts -->
    <div id="alertBox" class="hidden mb-6 rounded-lg border p-4"></div>

    <!-- Register Page -->
    <section id="page-register" class="space-y-6">
      <div class="bg-white rounded-xl shadow p-6 border">
        <h2 class="font-bold text-lg mb-4">기획 데이터 등록</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-700">업데이트 일자</label>
            <input id="r_update_date" type="date" class="mt-1 w-full border rounded-lg p-2" />
          </div>
          <div>
            <label class="text-sm text-gray-700">관련 작업</label>
            <input id="r_work" type="text" placeholder="예: ER-12345 / 작업명" class="mt-1 w-full border rounded-lg p-2" />
          </div>
          <div>
            <label class="text-sm text-gray-700">테이블 명</label>
            <input id="r_table_name" type="text" placeholder="예: Table_Whatever" class="mt-1 w-full border rounded-lg p-2" />
          </div>
          <div>
            <label class="text-sm text-gray-700">담당자</label>
            <input id="r_owner" type="text" placeholder="예: 혁" class="mt-1 w-full border rounded-lg p-2" />
          </div>

          <div class="md:col-span-2">
            <label class="text-sm text-gray-700">참고사항</label>
            <input id="r_note" type="text" placeholder="특이사항/주의사항" class="mt-1 w-full border rounded-lg p-2" />
          </div>

          <div class="md:col-span-2">
            <label class="text-sm text-gray-700">P4V 경로</label>
            <input id="r_p4_path" type="text" placeholder='예: //ER/Dev/Data/....' class="mt-1 w-full border rounded-lg p-2" />
          </div>
        </div>

        <div class="mt-5 flex gap-3">
          <button id="btnCreate"
            class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
            데이터 등록
          </button>
          <button id="btnCreateExample"
            class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">
            예시 채우기
          </button>
        </div>
      </div>
    </section>

    <!-- View Page -->
    <section id="page-view" class="hidden space-y-6">
      <div class="bg-white rounded-xl shadow p-6 border">
        <h2 class="font-bold text-lg mb-4">기획 데이터 확인</h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
          <div>
            <label class="text-sm text-gray-700">업데이트 일자</label>
            <input id="q_update_date" type="date" class="mt-1 w-full border rounded-lg p-2" />
          </div>
          <div>
            <label class="text-sm text-gray-700">관련 작업(부분검색)</label>
            <input id="q_work" type="text" placeholder="예: ER-123" class="mt-1 w-full border rounded-lg p-2" />
          </div>
          <div>
            <label class="text-sm text-gray-700">테이블 선택</label>
            <select id="q_table_name" class="mt-1 w-full border rounded-lg p-2">
              <option value="">(전체)</option>
            </select>
          </div>
          <div class="flex gap-2">
            <button id="btnSearch"
              class="flex-1 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
              조회
            </button>
            <button id="btnReset"
              class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">
              초기화
            </button>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-6 border">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">조회 결과</h3>
          <div class="text-sm text-gray-500">
            <span id="resultCount">0</span>건
          </div>
        </div>

        <div class="overflow-auto border rounded-lg">
          <table class="min-w-[900px] w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left p-3 border-b">업데이트 일자</th>
                <th class="text-left p-3 border-b">관련 작업</th>
                <th class="text-left p-3 border-b">테이블 명</th>
                <th class="text-left p-3 border-b">담당자</th>
                <th class="text-left p-3 border-b">P4V 경로</th>
                <th class="text-left p-3 border-b">참고사항</th>
              </tr>
            </thead>
            <tbody id="resultBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

<script>
  // ---------- UI helpers ----------
  const el = (id) => document.getElementById(id);

  function showAlert(type, msg) {
    const box = el("alertBox");
    box.classList.remove("hidden");
    box.className = "mb-6 rounded-lg border p-4"; // reset
    if (type === "success") box.classList.add("bg-green-50","border-green-200","text-green-800");
    if (type === "error") box.classList.add("bg-red-50","border-red-200","text-red-800");
    if (type === "info") box.classList.add("bg-blue-50","border-blue-200","text-blue-800");
    box.textContent = msg;
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function hideAlert() {
    el("alertBox").classList.add("hidden");
  }

  function toQS(params) {
    const usp = new URLSearchParams();
    Object.entries(params).forEach(([k, v]) => {
      if (v !== null && v !== undefined && String(v).trim() !== "") usp.set(k, v);
    });
    const s = usp.toString();
    return s ? `?${s}` : "";
  }

  // ---------- API ----------
  const API_BASE = "https://gdatamanage.onrender.com";
  
  async function apiFetch(path, options = {}) {
    const res = await fetch(`${API_BASE}${path}`, {
      ...options,
      headers: {
        "Content-Type": "application/json",
        ...(options.headers || {})
      },
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = text; }

    if (!res.ok) {
      const detail = (data && data.detail) ? JSON.stringify(data.detail) : (typeof data === "string" ? data : JSON.stringify(data));
      throw new Error(`${res.status} ${res.statusText} - ${detail}`);
    }
    return data;
  }

  async function createRecord(payload) {
    return apiFetch("/records", {
      method: "POST",
      body: JSON.stringify(payload),
    });
  }

  async function listRecords(filters) {
    return apiFetch("/records" + toQS(filters), { method: "GET" });
  }

  async function listTables() {
    return apiFetch("/tables", { method: "GET" });
  }

  // ---------- Pages ----------
  function showPage(page) {
    hideAlert();

    const isRegister = page === "register";
    el("page-register").classList.toggle("hidden", !isRegister);
    el("page-view").classList.toggle("hidden", isRegister);
    el("pageTitle").textContent = isRegister ? "기획 데이터 등록" : "기획 데이터 확인";
  }

  el("nav-register").addEventListener("click", () => showPage("register"));
  el("nav-view").addEventListener("click", async () => {
    showPage("view");
    await refreshTablesDropdown();
    await doSearch(); // 들어오자마자 한번 조회
  });

  // ---------- Register actions ----------
  el("btnCreateExample").addEventListener("click", () => {
    const today = new Date().toISOString().slice(0,10);
    el("r_update_date").value = today;
    el("r_work").value = "ER-99999";
    el("r_table_name").value = "Table_Test";
    el("r_owner").value = "혁";
    el("r_note").value = "프론트 연동 테스트";
    el("r_p4_path").value = "//ER/Dev/Data/Test/TestData.json";
  });

  el("btnCreate").addEventListener("click", async () => {
    try {
      hideAlert();

      const payload = {
        update_date: el("r_update_date").value,
        work: el("r_work").value.trim(),
        table_name: el("r_table_name").value.trim(),
        owner: el("r_owner").value.trim(),
        note: el("r_note").value.trim(),
        p4_path: el("r_p4_path").value.trim(),
      };

      // 간단 검증
      if (!payload.update_date) return showAlert("error", "업데이트 일자를 입력해줘.");
      if (!payload.work) return showAlert("error", "관련 작업을 입력해줘.");
      if (!payload.table_name) return showAlert("error", "테이블 명을 입력해줘.");
      if (!payload.owner) return showAlert("error", "담당자를 입력해줘.");
      if (!payload.p4_path) return showAlert("error", "P4V 경로를 입력해줘.");

      const created = await createRecord(payload);
      showAlert("success", `등록 완료! id=${created.id}`);

      // 등록 후 조회 페이지로 이동해서 바로 확인
      showPage("view");
      await refreshTablesDropdown();
      // 방금 등록한 값으로 필터 자동 세팅(원하면 제거 가능)
      el("q_update_date").value = payload.update_date;
      el("q_work").value = payload.work;
      el("q_table_name").value = payload.table_name;
      await doSearch();

    } catch (e) {
      showAlert("error", `등록 실패: ${e.message}`);
    }
  });

  // ---------- View actions ----------
  async function refreshTablesDropdown() {
    try {
      const tables = await listTables();
      const sel = el("q_table_name");
      const keep = sel.value;

      // reset
      sel.innerHTML = `<option value="">(전체)</option>`;
      tables.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      });

      // restore selection
      if (keep) sel.value = keep;
    } catch (e) {
      // tables가 없어도 조회는 가능하니 경고만
      console.warn(e);
    }
  }

  function renderRows(rows) {
    const tbody = el("resultBody");
    tbody.innerHTML = "";
    el("resultCount").textContent = rows.length;

    if (!rows.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="p-4 text-gray-500" colspan="6">조회 결과가 없습니다.</td>`;
      tbody.appendChild(tr);
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.className = "hover:bg-gray-50";
      tr.innerHTML = `
        <td class="p-3 border-b whitespace-nowrap">${r.update_date}</td>
        <td class="p-3 border-b">${escapeHtml(r.work)}</td>
        <td class="p-3 border-b whitespace-nowrap">${escapeHtml(r.table_name)}</td>
        <td class="p-3 border-b whitespace-nowrap">${escapeHtml(r.owner)}</td>
        <td class="p-3 border-b font-mono text-xs break-all">${escapeHtml(r.p4_path)}</td>
        <td class="p-3 border-b">${escapeHtml(r.note || "")}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  async function doSearch() {
    try {
      hideAlert();

      const filters = {
        update_date: el("q_update_date").value || "",
        work: el("q_work").value.trim(),
        table_name: el("q_table_name").value || "",
        limit: 200,
        offset: 0,
      };

      const rows = await listRecords(filters);
      renderRows(rows);

    } catch (e) {
      showAlert("error", `조회 실패: ${e.message}`);
    }
  }

  el("btnSearch").addEventListener("click", doSearch);

  el("btnReset").addEventListener("click", async () => {
    el("q_update_date").value = "";
    el("q_work").value = "";
    el("q_table_name").value = "";
    await doSearch();
  });

  // ---------- init ----------
  (async function init() {
    // 기본: 등록 페이지
    showPage("register");

    // 편의: 등록 날짜 기본값 = 오늘
    el("r_update_date").value = new Date().toISOString().slice(0,10);

    // 확인페이지 드롭다운 준비(실패해도 무시)
    await refreshTablesDropdown();
  })();
</script>
</body>
</html>
