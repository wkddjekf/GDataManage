<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GDataManage</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ✅ 엑셀/CSV 파싱용 SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-[#0f5b70] text-white p-6">
    <div class="text-2xl font-bold mb-8">기획데이터 관리</div>

    <nav class="space-y-3">
      <button id="nav-register" class="w-full text-left px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20">
        기획 데이터 등록
      </button>
      <button id="nav-view" class="w-full text-left px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20">
        기획 데이터 확인
      </button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-8">
    <!-- Top -->
    <header class="mb-6">
      <h1 id="pageTitle" class="text-2xl font-bold text-gray-900">기획 데이터 등록</h1>
      <p class="text-gray-600 mt-1">업데이트 작업별 변경 데이터(P4 경로/테이블 등)를 기록합니다.</p>
    </header>

    <!-- Alerts (에러/정보용으로 유지) -->
    <div id="alertBox" class="hidden mb-6 rounded-lg border p-4"></div>

    <!-- Register Page -->
    <section id="page-register" class="space-y-6">
      <div class="bg-white rounded-xl shadow p-6 border">
        <h2 class="font-bold text-lg mb-4">기획 데이터 등록</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-700">업데이트 일자</label>
            <input id="r_update_date" type="date" class="mt-1 w-full border rounded-lg p-2" />
          </div>
          <div>
            <label class="text-sm text-gray-700">관련 작업</label>
            <input id="r_work" type="text" placeholder="예: ER-12345 / 작업명" class="mt-1 w-full border rounded-lg p-2" />
          </div>
          <div>
            <label class="text-sm text-gray-700">테이블 명</label>
            <input id="r_table_name" type="text" placeholder="예: Table_Whatever" class="mt-1 w-full border rounded-lg p-2" />
          </div>
          <div>
            <label class="text-sm text-gray-700">담당자</label>
            <input id="r_owner" type="text" placeholder="예: 혁" class="mt-1 w-full border rounded-lg p-2" />
          </div>

          <div class="md:col-span-2">
            <label class="text-sm text-gray-700">참고사항</label>
            <input id="r_note" type="text" placeholder="특이사항/주의사항" class="mt-1 w-full border rounded-lg p-2" />
          </div>

          <div class="md:col-span-2">
            <label class="text-sm text-gray-700">P4V 경로</label>
            <input id="r_p4_path" type="text" placeholder='예: //ER/Dev/Data/....' class="mt-1 w-full border rounded-lg p-2" />
          </div>
        </div>

        <!-- ✅ 버튼 옆에 대량등록 버튼 -->
        <div class="mt-5 flex gap-3 flex-wrap">
          <button id="btnCreate"
            class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
            데이터 등록
          </button>
          <button id="btnCreateExample"
            class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">
            예시 채우기
          </button>
          <button id="btnBulkOpen"
            class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">
            CSV/엑셀 대량 등록
          </button>
        </div>
      </div>

      <!-- Register History -->
      <div class="bg-white rounded-xl shadow p-6 border">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">등록 히스토리</h3>
          <div class="text-sm text-gray-500">
            <span id="historyCount">0</span>건
          </div>
        </div>

        <div class="overflow-auto border rounded-lg">
          <table class="min-w-[900px] w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left p-3 border-b">업데이트 일자</th>
                <th class="text-left p-3 border-b">관련 작업</th>
                <th class="text-left p-3 border-b">테이블 명</th>
                <th class="text-left p-3 border-b">담당자</th>
                <th class="text-left p-3 border-b">P4V 경로</th>
                <th class="text-left p-3 border-b">참고사항</th>
                <th class="text-left p-3 border-b">삭제</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- View Page -->
    <section id="page-view" class="hidden space-y-6">
      <div class="bg-white rounded-xl shadow p-6 border">
        <h2 class="font-bold text-lg mb-4">기획 데이터 확인</h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
          <div>
            <label class="text-sm text-gray-700">업데이트 일자</label>
            <input id="q_update_date" type="date" class="mt-1 w-full border rounded-lg p-2" />
          </div>
          <div>
            <label class="text-sm text-gray-700">관련 작업(부분검색)</label>
            <input id="q_work" type="text" placeholder="예: ER-123" class="mt-1 w-full border rounded-lg p-2" />
          </div>
          <div>
            <label class="text-sm text-gray-700">테이블 선택</label>
            <select id="q_table_name" class="mt-1 w-full border rounded-lg p-2">
              <option value="">(전체)</option>
            </select>
          </div>
          <div class="flex gap-2">
            <button id="btnSearch"
              class="flex-1 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
              조회
            </button>
            <button id="btnReset"
              class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">
              초기화
            </button>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-6 border">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">조회 결과</h3>

          <div class="flex items-center gap-2">
            <button id="btnEditToggle"
              class="px-3 py-1 rounded border bg-white hover:bg-gray-50">
              편집 모드: OFF
            </button>
            <button id="btnSaveAll" class="hidden px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">
              저장
            </button>

            <div class="text-sm text-gray-500 ml-2">
              <span id="resultCount">0</span>건
            </div>
          </div>
        </div>

        <div class="overflow-auto border rounded-lg">
          <table class="min-w-[900px] w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left p-3 border-b">업데이트 일자</th>
                <th class="text-left p-3 border-b">관련 작업</th>
                <th class="text-left p-3 border-b">테이블 명</th>
                <th class="text-left p-3 border-b">담당자</th>
                <th class="text-left p-3 border-b">P4V 경로</th>
                <th class="text-left p-3 border-b">참고사항</th>
              </tr>
            </thead>
            <tbody id="resultBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- ✅ Success Modal (등록/업데이트 공용) -->
  <div id="successModal" class="fixed inset-0 hidden z-50">
    <div id="successOverlay" class="absolute inset-0 bg-black/50"></div>

    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md rounded-xl bg-white shadow-xl border">
        <div class="p-6">
          <h3 class="text-lg font-bold text-gray-900">알림</h3>
          <p id="successMessage" class="mt-3 text-gray-700 whitespace-pre-line">완료되었습니다.</p>

          <div class="mt-6 flex justify-end">
            <button id="btnSuccessOk"
              class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
              확인
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Bulk Import Modal -->
  <div id="bulkModal" class="fixed inset-0 hidden z-50">
    <div id="bulkOverlay" class="absolute inset-0 bg-black/50"></div>

    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-5xl rounded-xl bg-white shadow-xl border">
        <div class="p-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 class="text-lg font-bold text-gray-900">CSV/엑셀 대량 등록</h3>
              <p class="text-sm text-gray-600 mt-1">
                헤더는 <span class="font-mono">update_date, work, table_name, owner, note, p4_path</span>
                또는 한글(업데이트 일자/관련 작업/테이블 명/담당자/참고사항/P4V 경로)로 맞춰주세요.
              </p>
            </div>
            <button id="btnBulkClose" class="px-3 py-1 rounded border bg-white hover:bg-gray-50">닫기</button>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div class="md:col-span-2">
              <label class="text-sm text-gray-700">파일 선택 (.xlsx / .xls / .csv)</label>
              <input id="bulkFile" type="file" accept=".xlsx,.xls,.csv" class="mt-1 w-full border rounded-lg p-2 bg-white" />
            </div>

            <div class="flex gap-2">
              <button id="btnBulkParse"
                class="flex-1 px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">
                미리보기
              </button>
              <button id="btnBulkUpload"
                class="flex-1 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                업로드
              </button>
            </div>
          </div>

          <div class="mt-4 border rounded-lg overflow-auto">
            <table class="min-w-[1000px] w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="text-left p-3 border-b">#</th>
                  <th class="text-left p-3 border-b">업데이트 일자</th>
                  <th class="text-left p-3 border-b">관련 작업</th>
                  <th class="text-left p-3 border-b">테이블 명</th>
                  <th class="text-left p-3 border-b">담당자</th>
                  <th class="text-left p-3 border-b">P4V 경로</th>
                  <th class="text-left p-3 border-b">참고사항</th>
                  <th class="text-left p-3 border-b">검증</th>
                </tr>
              </thead>
              <tbody id="bulkPreviewBody">
                <tr><td class="p-4 text-gray-500" colspan="8">파일을 선택한 뒤 “미리보기”를 눌러주세요.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="mt-3 text-sm text-gray-600">
            총 <span id="bulkTotal" class="font-bold">0</span>건 /
            업로드 가능 <span id="bulkValid" class="font-bold text-green-700">0</span>건 /
            오류 <span id="bulkInvalid" class="font-bold text-red-700">0</span>건
          </div>

          <!-- ✅ 업로드 진행률 표시 -->
          <div id="bulkProgressWrap" class="mt-4 hidden">
            <div class="flex items-center justify-between text-sm">
              <div class="text-gray-700 font-semibold">업로드 진행</div>
              <div class="text-gray-600">
                <span id="bulkProgDone">0</span>/<span id="bulkProgTotal">0</span>
                · 성공 <span id="bulkProgOk" class="font-bold text-green-700">0</span>
                · 실패 <span id="bulkProgFail" class="font-bold text-red-700">0</span>
              </div>
            </div>

            <div class="mt-2 w-full h-3 bg-gray-200 rounded-full overflow-hidden">
              <div id="bulkProgBar" class="h-3 bg-blue-600 w-0"></div>
            </div>

            <div id="bulkProgMsg" class="mt-2 text-xs text-gray-500">준비 중...</div>
          </div>

          <div class="mt-5 flex justify-end gap-2">
            <button id="btnBulkCancel"
              class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">
              닫기
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const API_BASE = "https://gdatamanage.onrender.com";

  // ---------- UI helpers ----------
  const el = (id) => document.getElementById(id);

  function showAlert(type, msg) {
    const box = el("alertBox");
    box.classList.remove("hidden");
    box.className = "mb-6 rounded-lg border p-4"; // reset
    if (type === "success") box.classList.add("bg-green-50","border-green-200","text-green-800");
    if (type === "error") box.classList.add("bg-red-50","border-red-200","text-red-800");
    if (type === "info") box.classList.add("bg-blue-50","border-blue-200","text-blue-800");
    box.textContent = msg;
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function hideAlert() {
    el("alertBox").classList.add("hidden");
  }

  // ✅ Success modal helpers
  function openSuccessModal(message = "완료되었습니다.") {
    el("successMessage").textContent = message;
    el("successModal").classList.remove("hidden");
  }
  function closeSuccessModal() {
    el("successModal").classList.add("hidden");
  }

  function toQS(params) {
    const usp = new URLSearchParams();
    Object.entries(params).forEach(([k, v]) => {
      if (v !== null && v !== undefined && String(v).trim() !== "") usp.set(k, v);
    });
    const s = usp.toString();
    return s ? `?${s}` : "";
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // ---------- API ----------
  async function apiFetch(path, options = {}) {
    const res = await fetch(`${API_BASE}${path}`, {
      ...options,
      headers: {
        "Content-Type": "application/json",
        ...(options.headers || {})
      },
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = text; }

    if (!res.ok) {
      const detail = (data && data.detail) ? JSON.stringify(data.detail) : (typeof data === "string" ? data : JSON.stringify(data));
      throw new Error(`${res.status} ${res.statusText} - ${detail}`);
    }
    return data;
  }

  async function createRecord(payload) {
    return apiFetch("/records", {
      method: "POST",
      body: JSON.stringify(payload),
    });
  }

  async function listRecords(filters) {
    return apiFetch("/records" + toQS(filters), { method: "GET" });
  }

  async function listTables() {
    return apiFetch("/tables", { method: "GET" });
  }

  async function deleteRecord(id) {
    return apiFetch(`/records/${id}`, { method: "DELETE" });
  }

  async function updateRecord(id, payload) {
    return apiFetch(`/records/${id}`, {
      method: "PATCH",
      body: JSON.stringify(payload),
    });
  }

  // ---------- Pages ----------
  function showPage(page) {
    hideAlert();

    const isRegister = page === "register";
    el("page-register").classList.toggle("hidden", !isRegister);
    el("page-view").classList.toggle("hidden", isRegister);
    el("pageTitle").textContent = isRegister ? "기획 데이터 등록" : "기획 데이터 확인";
  }

  el("nav-register").addEventListener("click", async () => {
    showPage("register");
    await refreshHistory();
  });

  el("nav-view").addEventListener("click", async () => {
    showPage("view");
    await refreshTablesDropdown();
    await doSearch();
  });

  // ✅ modal event wiring (success)
  el("btnSuccessOk").addEventListener("click", closeSuccessModal);
  el("successOverlay").addEventListener("click", closeSuccessModal);

  // ✅ modal event wiring (bulk)
  function openBulkModal() {
    el("bulkModal").classList.remove("hidden");
  }
  function closeBulkModal() {
    el("bulkModal").classList.add("hidden");
  }

  el("btnBulkOpen").addEventListener("click", openBulkModal);
  el("btnBulkClose").addEventListener("click", closeBulkModal);
  el("btnBulkCancel").addEventListener("click", closeBulkModal);
  el("bulkOverlay").addEventListener("click", closeBulkModal);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeSuccessModal();
      closeBulkModal();
    }
  });

  // ---------- Register actions ----------
  el("btnCreateExample").addEventListener("click", () => {
    const today = new Date().toISOString().slice(0,10);
    el("r_update_date").value = today;
    el("r_work").value = "ER-99999";
    el("r_table_name").value = "Table_Test";
    el("r_owner").value = "혁";
    el("r_note").value = "프론트 연동 테스트";
    el("r_p4_path").value = "//ER/Dev/Data/Test/TestData.json";
  });

  el("btnCreate").addEventListener("click", async () => {
    try {
      hideAlert();

      const payload = {
        update_date: el("r_update_date").value,
        work: el("r_work").value.trim(),
        table_name: el("r_table_name").value.trim(),
        owner: el("r_owner").value.trim(),
        note: el("r_note").value.trim(),
        p4_path: el("r_p4_path").value.trim(),
      };

      if (!payload.update_date) return showAlert("error", "업데이트 일자를 입력해줘.");
      if (!payload.work) return showAlert("error", "관련 작업을 입력해줘.");
      if (!payload.table_name) return showAlert("error", "테이블 명을 입력해줘.");
      if (!payload.owner) return showAlert("error", "담당자를 입력해줘.");
      if (!payload.p4_path) return showAlert("error", "P4V 경로를 입력해줘.");

      const created = await createRecord(payload);

      // ✅ 등록 성공: 모달로 안내
      openSuccessModal(`등록이 완료되었습니다.\n(id=${created.id})`);

      await refreshHistory();

    } catch (e) {
      showAlert("error", `등록 실패: ${e.message}`);
    }
  });

  function renderHistory(rows) {
    const tbody = el("historyBody");
    tbody.innerHTML = "";
    el("historyCount").textContent = rows.length;

    if (!rows.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="p-4 text-gray-500" colspan="7">히스토리가 없습니다.</td>`;
      tbody.appendChild(tr);
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.className = "hover:bg-gray-50";
      tr.innerHTML = `
        <td class="p-3 border-b whitespace-nowrap">${r.update_date}</td>
        <td class="p-3 border-b">${escapeHtml(r.work)}</td>
        <td class="p-3 border-b whitespace-nowrap">${escapeHtml(r.table_name)}</td>
        <td class="p-3 border-b whitespace-nowrap">${escapeHtml(r.owner)}</td>
        <td class="p-3 border-b font-mono text-xs break-all">${escapeHtml(r.p4_path)}</td>
        <td class="p-3 border-b">${escapeHtml(r.note || "")}</td>
        <td class="p-3 border-b whitespace-nowrap">
          <button data-del-id="${r.id}" class="px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">
            삭제
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("[data-del-id]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del-id");
        if (!confirm("정말 삭제할까요?")) return;
        try {
          await deleteRecord(id);
          openSuccessModal("삭제가 완료되었습니다.");
          await refreshHistory();
        } catch (e) {
          showAlert("error", `삭제 실패: ${e.message}`);
        }
      });
    });
  }

  async function refreshHistory() {
    const rows = await listRecords({ limit: 50, offset: 0 });
    rows.sort((a, b) => String(b.update_date).localeCompare(String(a.update_date)));
    renderHistory(rows);
  }

  // ---------- View actions ----------
  async function refreshTablesDropdown() {
    try {
      const tables = await listTables();
      const sel = el("q_table_name");
      const keep = sel.value;

      sel.innerHTML = `<option value="">(전체)</option>`;
      tables.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      });

      if (keep) sel.value = keep;
    } catch (e) {
      console.warn(e);
    }
  }

  let editMode = false;

  el("btnEditToggle").addEventListener("click", async () => {
    editMode = !editMode;
    el("btnEditToggle").textContent = editMode ? "편집 모드: ON" : "편집 모드: OFF";
    el("btnSaveAll").classList.toggle("hidden", !editMode);
    await doSearch();
  });

  el("btnSaveAll").addEventListener("click", async () => {
    try {
      const tbody = el("resultBody");
      const inputs = tbody.querySelectorAll("[data-edit-id]");

      const byId = {};
      inputs.forEach(inp => {
        const id = inp.getAttribute("data-edit-id");
        const field = inp.getAttribute("data-edit-field");
        if (!byId[id]) byId[id] = {};
        byId[id][field] = inp.value;
      });

      const ids = Object.keys(byId);
      for (const id of ids) {
        const p = byId[id];
        const payload = {
          update_date: p.update_date || "",
          work: p.work || "",
          table_name: p.table_name || "",
          owner: p.owner || "",
          note: p.note || "",
          p4_path: p.p4_path || "",
        };

        if (!payload.update_date || !payload.work || !payload.table_name || !payload.owner || !payload.p4_path) {
          throw new Error("필수값(일자/작업/테이블/담당자/P4경로) 누락된 행이 있어요.");
        }

        await updateRecord(id, payload);
      }

      // ✅ 업데이트 성공: 모달로 안내
      openSuccessModal("업데이트가 완료되었습니다.");
      await doSearch();

    } catch (e) {
      showAlert("error", `저장 실패: ${e.message}`);
    }
  });

  function renderRows(rows) {
    const tbody = el("resultBody");
    tbody.innerHTML = "";
    el("resultCount").textContent = rows.length;

    if (!rows.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="p-4 text-gray-500" colspan="6">조회 결과가 없습니다.</td>`;
      tbody.appendChild(tr);
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.className = "hover:bg-gray-50";

      const cell = (field, value, type = "text") => {
        if (!editMode) return escapeHtml(value ?? "");
        const v = (value ?? "");
        return `<input data-edit-id="${r.id}" data-edit-field="${field}" type="${type}"
                  class="w-full border rounded p-2" value="${escapeHtml(v)}" />`;
      };

      tr.innerHTML = `
        <td class="p-3 border-b whitespace-nowrap">${cell("update_date", r.update_date, "date")}</td>
        <td class="p-3 border-b">${cell("work", r.work)}</td>
        <td class="p-3 border-b whitespace-nowrap">${cell("table_name", r.table_name)}</td>
        <td class="p-3 border-b whitespace-nowrap">${cell("owner", r.owner)}</td>
        <td class="p-3 border-b font-mono text-xs break-all">${cell("p4_path", r.p4_path)}</td>
        <td class="p-3 border-b">${cell("note", r.note || "")}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function doSearch() {
    try {
      hideAlert();

      const filters = {
        update_date: el("q_update_date").value || "",
        work: el("q_work").value.trim(),
        table_name: el("q_table_name").value || "",
        limit: 200,
        offset: 0,
      };

      const rows = await listRecords(filters);
      renderRows(rows);

    } catch (e) {
      showAlert("error", `조회 실패: ${e.message}`);
    }
  }

  el("btnSearch").addEventListener("click", doSearch);

  el("btnReset").addEventListener("click", async () => {
    el("q_update_date").value = "";
    el("q_work").value = "";
    el("q_table_name").value = "";
    await doSearch();
  });

  // =========================
  // ✅ Bulk Import (CSV/Excel)
  // =========================
  let bulkRows = []; // {payload, ok, reason, idx}

  function normKey(k) {
    return String(k || "")
      .trim()
      .toLowerCase()
      .replaceAll("\uFEFF", "")
      .replaceAll(/\s+/g, "")
      .replaceAll(/_/g, "");
  }

  function normalizeDate(v) {
    if (v === null || v === undefined) return "";
    if (v instanceof Date && !isNaN(v.getTime())) return v.toISOString().slice(0,10);

    const s = String(v).trim();
    if (!s) return "";
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

    if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(s)) {
      const [y,m,d] = s.split("/");
      return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    }
    if (/^\d{4}\.\d{1,2}\.\d{1,2}$/.test(s)) {
      const [y,m,d] = s.split(".");
      return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    }

    if (/^\d+(\.\d+)?$/.test(s)) {
      const n = Number(s);
      if (!isNaN(n) && n > 20000 && n < 90000) {
        const utcDays = Math.floor(n - 25569);
        const utcMs = utcDays * 86400 * 1000;
        const dt = new Date(utcMs);
        if (!isNaN(dt.getTime())) return dt.toISOString().slice(0,10);
      }
    }

    const dt = new Date(s);
    if (!isNaN(dt.getTime())) return dt.toISOString().slice(0,10);

    return s;
  }

  function mapRowToPayload(rowObj) {
    const keys = Object.keys(rowObj || {});
    const byNorm = {};
    keys.forEach(k => { byNorm[normKey(k)] = k; });

    const pick = (aliases) => {
      for (const a of aliases) {
        const hit = byNorm[normKey(a)];
        if (hit !== undefined) return rowObj[hit];
      }
      return "";
    };

    return {
      update_date: normalizeDate(pick(["update_date","업데이트일자","업데이트 일자","일자"])),
      work: String(pick(["work","관련작업","관련 작업"]) || "").trim(),
      table_name: String(pick(["table_name","테이블명","테이블 명"]) || "").trim(),
      owner: String(pick(["owner","담당자"]) || "").trim(),
      note: String(pick(["note","참고사항","참고 사항","비고"]) || "").trim(),
      p4_path: String(pick(["p4_path","p4v경로","p4v 경로","p4경로","p4 경로","P4V경로","P4V 경로"]) || "").trim(),
    };
  }

  function isEmptyPayload(p) {
    return !p.update_date && !p.work && !p.table_name && !p.owner && !p.note && !p.p4_path;
  }

  function validatePayload(p) {
    if (!p.update_date) return "업데이트 일자 누락";
    if (!/^\d{4}-\d{2}-\d{2}$/.test(p.update_date)) return "업데이트 일자 형식 오류(YYYY-MM-DD)";
    if (!p.work) return "관련 작업 누락";
    if (!p.table_name) return "테이블 명 누락";
    if (!p.owner) return "담당자 누락";
    if (!p.p4_path) return "P4V 경로 누락";
    return "";
  }

  function renderBulkPreview(items) {
    const tbody = el("bulkPreviewBody");
    tbody.innerHTML = "";

    const total = items.length;
    const valid = items.filter(x => x.ok).length;
    const invalid = total - valid;

    el("bulkTotal").textContent = total;
    el("bulkValid").textContent = valid;
    el("bulkInvalid").textContent = invalid;

    el("btnBulkUpload").disabled = valid === 0;

    if (!items.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="p-4 text-gray-500" colspan="8">미리보기 데이터가 없습니다. (빈 행은 자동 제외됩니다)</td>`;
      tbody.appendChild(tr);
      return;
    }

    const showN = Math.min(items.length, 200);
    for (let i = 0; i < showN; i++) {
      const it = items[i];
      const p = it.payload;

      const tr = document.createElement("tr");
      tr.className = "hover:bg-gray-50";
      tr.innerHTML = `
        <td class="p-3 border-b whitespace-nowrap">${it.idx}</td>
        <td class="p-3 border-b whitespace-nowrap">${escapeHtml(p.update_date || "")}</td>
        <td class="p-3 border-b">${escapeHtml(p.work || "")}</td>
        <td class="p-3 border-b whitespace-nowrap">${escapeHtml(p.table_name || "")}</td>
        <td class="p-3 border-b whitespace-nowrap">${escapeHtml(p.owner || "")}</td>
        <td class="p-3 border-b font-mono text-xs break-all">${escapeHtml(p.p4_path || "")}</td>
        <td class="p-3 border-b">${escapeHtml(p.note || "")}</td>
        <td class="p-3 border-b whitespace-nowrap">
          ${
            it.ok
              ? `<span class="text-green-700 font-bold">OK</span>`
              : `<span class="text-red-700 font-bold">ERR</span> <span class="text-xs text-gray-600">${escapeHtml(it.reason)}</span>`
          }
        </td>
      `;
      tbody.appendChild(tr);
    }

    if (items.length > showN) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="p-4 text-gray-500" colspan="8">미리보기는 ${showN}건까지만 표시됩니다. (업로드는 전체 적용)</td>`;
      tbody.appendChild(tr);
    }
  }

  async function parseBulkFile(file) {
    const name = (file.name || "").toLowerCase();

    if (name.endsWith(".csv")) {
      const text = await file.text();
      const wb = XLSX.read(text, { type: "string" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(ws, { defval: "" });
    }

    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(ws, { defval: "" });
  }

  function buildBulkItems(rowObjects) {
    const items = [];
    let idx = 0;

    for (const rowObj of (rowObjects || [])) {
      idx += 1;
      const payload = mapRowToPayload(rowObj);
      if (isEmptyPayload(payload)) continue;

      const reason = validatePayload(payload);
      items.push({ idx, payload, ok: !reason, reason: reason || "" });
    }
    return items;
  }

  // ✅ 진행률 표시 helpers
  function bulkProgressReset(total) {
    el("bulkProgressWrap").classList.remove("hidden");
    el("bulkProgTotal").textContent = String(total);
    el("bulkProgDone").textContent = "0";
    el("bulkProgOk").textContent = "0";
    el("bulkProgFail").textContent = "0";
    el("bulkProgBar").style.width = "0%";
    el("bulkProgMsg").textContent = "업로드를 시작합니다...";
  }

  function bulkProgressUpdate(done, total, ok, fail, msg) {
    el("bulkProgDone").textContent = String(done);
    el("bulkProgOk").textContent = String(ok);
    el("bulkProgFail").textContent = String(fail);

    const pct = total > 0 ? Math.floor((done / total) * 100) : 0;
    el("bulkProgBar").style.width = `${pct}%`;
    if (msg) el("bulkProgMsg").textContent = msg;
  }

  function bulkProgressHide() {
    el("bulkProgressWrap").classList.add("hidden");
  }

  el("btnBulkParse").addEventListener("click", async () => {
    try {
      hideAlert();
      bulkProgressHide();

      const file = el("bulkFile").files && el("bulkFile").files[0];
      if (!file) return showAlert("error", "파일을 선택해줘. (.xlsx/.xls/.csv)");

      showAlert("info", "파일을 읽는 중...");
      const rows = await parseBulkFile(file);

      bulkRows = buildBulkItems(rows);
      renderBulkPreview(bulkRows);

      showAlert("success", `미리보기 완료: 총 ${bulkRows.length}건 (업로드 가능 ${bulkRows.filter(x=>x.ok).length}건)`);

    } catch (e) {
      showAlert("error", `미리보기 실패: ${e.message}`);
    }
  });

  el("btnBulkUpload").addEventListener("click", async () => {
    try {
      hideAlert();

      if (!bulkRows || bulkRows.length === 0) {
        return showAlert("error", "업로드할 데이터가 없습니다. 먼저 미리보기를 실행해줘.");
      }

      const validItems = bulkRows.filter(x => x.ok);
      if (validItems.length === 0) {
        return showAlert("error", "업로드 가능한(OK) 데이터가 없습니다. 오류 행을 수정해줘.");
      }

      if (!confirm(`업로드 가능한 ${validItems.length}건을 등록할까요?`)) return;

      // ✅ UI Lock
      el("btnBulkUpload").disabled = true;
      el("btnBulkParse").disabled = true;
      el("bulkFile").disabled = true;
      el("btnBulkClose").disabled = true;
      el("btnBulkCancel").disabled = true;

      // ✅ Progress init
      bulkProgressReset(validItems.length);

      let ok = 0;
      let fail = 0;
      const failSamples = [];
      const total = validItems.length;

      for (let i = 0; i < validItems.length; i++) {
        const it = validItems[i];

        try {
          await createRecord(it.payload);
          ok += 1;
        } catch (e) {
          fail += 1;
          if (failSamples.length < 10) {
            failSamples.push(`#${it.idx}: ${e.message}`);
          }
        }

        const done = i + 1;
        bulkProgressUpdate(
          done,
          total,
          ok,
          fail,
          `업로드 중... ${done}/${total} (성공 ${ok}, 실패 ${fail})`
        );

        // 서버 보호(너무 빠른 연속 호출 방지)
        await new Promise(r => setTimeout(r, 80));
      }

      await refreshHistory();

      // ✅ 완료 메시지 (팝업)
      if (fail === 0) {
        openSuccessModal(`대량 등록이 완료되었습니다.\n(성공 ${ok}건)`);
      } else {
        const sampleText =
          failSamples.length
            ? `\n\n실패 샘플:\n${failSamples.join("\n")}${fail > failSamples.length ? `\n...외 ${fail - failSamples.length}건` : ""}`
            : "";
        openSuccessModal(`대량 등록이 완료되었습니다.\n(성공 ${ok}건 / 실패 ${fail}건)${sampleText}`);
      }

      // ✅ bulk 모달 닫기
      el("bulkModal").classList.add("hidden");

    } catch (e) {
      showAlert("error", `대량 등록 실패: ${e.message}`);
    } finally {
      // ✅ UI Unlock
      el("btnBulkUpload").disabled = false;
      el("btnBulkParse").disabled = false;
      el("bulkFile").disabled = false;
      el("btnBulkClose").disabled = false;
      el("btnBulkCancel").disabled = false;
    }
  });

  // ---------- init ----------
  (async function init() {
    showPage("register");
    el("r_update_date").value = new Date().toISOString().slice(0,10);

    await refreshTablesDropdown();
    await refreshHistory();
  })();
</script>
</body>
</html>
